#!/bin/bash
#
# config-push - safely push the config

ROOT=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../..")

# always add patch if there is nothing staged
git -C "$ROOT" diff --cached --quiet
if [ $? -eq 0 ]; then
    git -C "$ROOT" add --patch
else
    # show changes but shortened
    git -C "$ROOT" diff --cached --compact-summary

    while true; do
        read -p "Do you wish to add anything else before commiting? (Y/n)" yn
        case $yn in
            # no, just continue
            [Nn]* ) break;;

            # yes
            * )
                git -C "$ROOT" add --patch
                break
                ;;
        esac
    done
fi

# then allow editing the message but provide default
git -C "$ROOT" commit --message="#A $(hostname) ($(date +"%Y-%m-%dT%H:%M:%S%z"))" --edit || exit 0

# push
git -C "$ROOT" push

