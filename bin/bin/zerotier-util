#!/usr/bin/env python3
#
# zerotier-util-py

#curl -s -X GET -H "Authorization: token $API_KEY" "https://api.zerotier.com/api/v1${1}"

import os, subprocess, urllib, json, datetime
from urllib.request import Request, urlopen

# TODO: try to get api key from environ first
# get api key
API_KEY = subprocess.run(['pass', 'zerotier-api-key'], stdout=subprocess.PIPE).stdout.decode('utf-8').strip()

def api(url):
    try:
        body = urlopen(Request(
            "https://api.zerotier.com/api/v1" + url,
            headers={
                'Authorization': 'token ' + API_KEY,
            },
        )).read().decode()
    except urllib.error.HTTPError as e: # TODO quit and print error
        body = e.read().decode()  # Read the body of the error response

    return json.loads(body)

networks = api('/network')
for i in networks:
    id = i['id']
    print(f"Network {id} members:")
    members = api(f"/network/{id}/member")

    for j in members:
        print(f"""{j['type']} '{j['name']}' ({j['nodeId']})
  Description '{j['description']}'
  Online {j['online']}
  Last Online {datetime.datetime.fromtimestamp(j['lastOnline']/1000.0)}
  PhyIP {j['physicalAddress']}
  ZT Assigned IPs:""")
        for k in j['config']['ipAssignments']:
            print('    ' + k)
        print()

