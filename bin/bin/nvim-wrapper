#!/usr/bin/env bash
#
# https://github.com/sandorex/config
# neovim flatpak wrapper script

set -eu

# NOTE: python is included by default
FLATPAK_EXT="rust-stable,node18"

args=()

POSITIONAL_ARGS=()

while [ $# -gt 0 ]; do
    case $1 in
	--network)
            args+=( "--share=network" )
            ;;
        --install)
            echo "Installing neovim flatpak"

            flatpak install -y flathub io.neovim.nvim

            echo "Installing flatpak extension SDKs '$FLATPAK_EXT'"

            # converting the comma to space
            for i in ${FLATPAK_EXT/,/ }; do
                flatpak install -y "org.freedesktop.Sdk.Extension.$i"
            done

            exit 0
            ;;
        *)
            # save positional arg
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

# restore positional parameters
set -- "${POSITIONAL_ARGS[@]}"

POSITIONAL_ARGS=()

while [ $# -gt 0 ]; do
    case $1 in
        # TODO this is temporary solution, its simple rework into something
        # better for real world use
        --)
            # consume all args left as paths
            for i in "$@"; do
                if [[ -e "$i" ]]; then
                    # if it exists just allow it
                    args+=( "--filesystem='$i'" )

                    # nothing more needed
                    continue
                fi

                invalid_path=1
                echo "Invalid path '$i', it does not exist and for security reasons wont be created"
            done

            if [[ -n "$invalid_path" ]]; then
                echo "Failed cause of the previous errors"
                exit 69
            fi

            # add rest of args
            POSITIONAL_ARGS+=("$@")
            break
            ;;
        *)

            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

# restore positional parameters
set -- "${POSITIONAL_ARGS[@]}"

# TODO remove the exception for config and figure out some solution

# all default permissions are removed and explicitely defined here
# no networking by default
# no filesystem access by default (only the config)
FLATPAK_ENABLE_SDK_EXT="$FLATPAK_EXT" flatpak run \
    --sandbox \
    --socket=wayland \
    --socket=fallback-x11 \
    --share=ipc \
    --env="TERMINFO_DIRS=/var/run/host/usr/share/terminfo:/usr/share/terminfo" \
    --filesystem=host-os \
    --persist=.config/nvim \
    --persist=.local/share/nvim \
    --persist=.local/state/nvim \
    --persist=.cache/nvim \
    --filesystem="$DOTFILES/nvim/nvim" \
    "${args[@]}" \
    io.neovim.nvim "$@"
